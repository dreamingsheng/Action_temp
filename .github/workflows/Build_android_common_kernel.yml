name: Download Android Kernel Source

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install Dependencies
      run: |
        sudo apt update && sudo apt install -y git curl

    - name: Maximize Build Space
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 4096
        
    - name: Remove Existing git-repo Directory
      run: |
        if [ -d "$GITHUB_WORKSPACE/git-repo" ]; then
          rm -rf "$GITHUB_WORKSPACE/git-repo"
        fi

    - name: Initialize and Sync Android Kernel Source
      run: |
        cd $GITHUB_WORKSPACE
        git clone https://gerrit.googlesource.com/git-repo
        mkdir android-kernel && cd android-kernel
        ../git-repo/repo init --depth=1 --u https://android.googlesource.com/kernel/manifest -b common-android12-5.10
        ../git-repo/repo sync
        cd common
        git checkout --orphan android12-5.10-2022-04
        ls -l

    - name: Package Kernel Source
      run: |
        cd $GITHUB_WORKSPACE/android-kernel
        ls -l
        zip -r kernel-source.zip ./*
        ls -l
      shell: bash

    - name: Verify zip file creation
      run: |
        if [ -f $GITHUB_WORKSPACE/android-kernel/kernel-source.zip ]; then
          echo "Zip file created successfully."
        else
          echo "Zip file was not created."
          exit 1
        fi
      shell: bash

    - name: Split Zip File if Necessary
      run: |
        cd $GITHUB_WORKSPACE/android-kernel
        FILESIZE=$(stat -c%s "kernel-source.zip")
        MAXSIZE=$((2 * 1024 * 1024 * 1024))
        if [ $FILESIZE -gt $MAXSIZE ]; then
          split -b 2000m kernel-source.zip kernel-source.zip.part-
        fi
      shell: bash

    - name: Upload Kernel Source Package or Parts
      run: |
        cd $GITHUB_WORKSPACE/android-kernel
        if [ -f kernel-source.zip.part-aa ]; then
          for PART in kernel-source.zip.part-*; do
            echo "Uploading $PART..."
            mv "$PART" "${PART}.zip"
            gh run upload-artifact --name android-kernel-source-${PART} --path $PART.zip
          done
        else
          gh run upload-artifact --name android-kernel-source --path kernel-source.zip
        fi
      shell: bash
